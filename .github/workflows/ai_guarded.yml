name: NTRLI AI Guarded Execution

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: 'Task instruction for NTRLI AI'
        required: true
        type: string
      strategy:
        description: 'Router strategy'
        required: false
        type: choice
        options:
          - fastest
          - cheapest
          - smartest
          - consensus
          - fallback
        default: fallback

jobs:
  execute:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute NTRLI AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROUTER_STRATEGY: ${{ inputs.strategy }}
        working-directory: ntrli_ai
        run: |
          python main.py "${{ inputs.instruction }}"

      - name: Commit results
        if: success()
        run: |
          git config user.name "NTRLI AI"
          git config user.email "ntrli-ai@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "NTRLI AI [${{ inputs.strategy }}]: ${{ inputs.instruction }}"
          git push
