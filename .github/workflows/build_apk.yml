# ============================================================================
# NTRLI' AI - Android APK Build (Using Buildozer Action)
# ============================================================================
# Uses ArtemSBulgakov/buildozer-action for reliable builds

name: Build Android APK

on:
  push:
    branches: [main, master, 'claude/*']
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  # ============================================================================
  # APK Build Job
  # ============================================================================
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build with Buildozer
        uses: ArtemSBulgakov/buildozer-action@v1
        id: buildozer
        with:
          command: buildozer android ${{ github.event.inputs.build_type || 'debug' }}
          workdir: android_app
          buildozer_version: stable

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ntrli-ai-apk
          path: android_app/bin/*.apk
          retention-days: 30

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log
          path: android_app/.buildozer/logs/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Release Job - ALWAYS RUNS
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: ntrli-ai-apk
          path: ./apk
        continue-on-error: true

      - name: List files
        run: |
          echo "=== APK files ==="
          find . -name "*.apk" -ls 2>/dev/null || echo "No APK found"
          ls -la ./apk/ 2>/dev/null || echo "No apk directory"

      - name: Generate tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=v1.0.0-build.${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "NTRLI' AI ${{ steps.tag.outputs.tag }}"
          files: ./apk/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: true
          body: |
            ## NTRLI' AI Release

            Build: ${{ github.event.inputs.build_type || 'debug' }}
            Run: #${{ github.run_number }}

            ### Installation
            1. Download the APK
            2. Enable "Install from unknown sources"
            3. Install and open the app
            4. Configure API keys in Settings
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "# Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
